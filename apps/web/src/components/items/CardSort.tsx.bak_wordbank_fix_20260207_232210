"use client";

import { useEffect, useMemo, useState } from "react";
import type { ItemCardSort } from "@/types/item";

export default function CardSort({
  item,
  onChecked,
  checkSignal,
}: {
  item: ItemCardSort;
  onChecked: (r: { score: number; max: number }) => void;
  checkSignal?: number;
}) {
  const [dragId, setDragId] = useState<string | null>(null);

const [bank, setBank] = useState<string[]>(() => item.cards.map((c) => c.id));
  const [cols, setCols] = useState<Record<string, string[]>>(() => {
    const m: Record<string, string[]> = {};
    item.columns.forEach((c) => (m[c.id] = []));

    const fallback = item.columns[0]?.id;
    item.cards.forEach((c) => {
      const col = c.columnId && m[c.columnId] ? c.columnId : fallback;
      if (!col) return;
      m[col].push(c.id);
    });

    return m;
  });

  const [lastScore, setLastScore] = useState<{ score: number; max: number } | null>(null);

  const cardById = useMemo(() => {
    return Object.fromEntries(item.cards.map((c) => [c.id, c]));
  }, [item.cards]);

  function onDrop(targetColId: string) {
  if (!dragId) return;
    setCols((prev) => {
      const out: Record<string, string[]> = {};
      for (const k of Object.keys(prev)) out[k] = prev[k].filter((id) => id !== dragId);
      (out[targetColId] ??= []).push(dragId);
      return out;
    });

  setBank((b) => b.filter((id) => id !== dragId));
    setDragId(null);
  }

  function scoreNow() {
    const total = item.cards.length;
    let correct = 0;

    for (const [colId, ids] of Object.entries(cols)) {
      ids.forEach((cid) => {
        if (item.correct[cid] === colId) correct++;
      });
    }

    const r = { score: correct, max: total };
    setLastScore(r);
    onChecked(r);
  }

  // Trigger check from parent (e.g., "Check Answer" button)
  useEffect(() => {
    if (checkSignal == null) return;
    scoreNow();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [checkSignal]);

  return (
    <div className="space-y-4">
      <div className="text-lg font-semibold">{item.stem}</div>

      <div className="grid md:grid-cols-2 gap-4">
        {item.columns.map((col) => (
          <div
            key={col.id}
            className="p-3 border rounded min-h-[120px]"
            onDragOver={(e) => e.preventDefault()}
            onDrop={() => onDrop(col.id)}
          >
            <div className="text-sm font-semibold mb-2">{col.label}</div>

            <div className="flex flex-wrap gap-2">
              {(cols[col.id] ?? []).map((cid) => (
                <div
                  key={cid}
                  draggable
                  onDragStart={() => setDragId(cid)}
                  className="px-2 py-1 rounded border bg-white shadow-sm cursor-move"
                >
                  {cardById[cid]?.text ?? cid}
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>

      <div className="sticky bottom-0 -mx-1 mt-3 flex items-center justify-between gap-3 rounded-xl border bg-white/90 px-3 py-2 backdrop-blur">
        <div className="text-xs text-slate-600">
          {lastScore ? (
            <span>
              Score: <span className="font-semibold text-slate-900">{lastScore.score}</span>
              <span className="text-slate-400"> / </span>
              <span className="font-semibold text-slate-900">{lastScore.max}</span>
            </span>
          ) : (
            <span>Ready when you are.</span>
          )}
        </div>

        <button
          data-check-button="true"
          type="button"
          onClick={scoreNow}
          className="rounded-xl border px-4 py-2 text-sm font-medium hover:bg-slate-50"
        >
          Check
        </button>
      </div>
    </div>
  );
}
